function complex_expression(G){function H(){q.push(1);for(var a=0;160>a;++a)q.push(q[q.length-1]*q.length)}function r(a){return a.r*a.r+a.i*a.i}function u(a,b){return{r:a.r*b.r-a.i*b.i,i:a.r*b.i+a.i*b.r}}function x(a,b){var d=r(b);return{r:(a.r*b.r+a.i*b.i)/d,i:(a.i*b.r-a.r*b.i)/d}}function D(a){var b=Math.exp(a.r);return{r:b*Math.cos(a.i),i:b*Math.sin(a.i)}}function n(a,b){if(1==b)return a;if(0==b%2){var d=n(a,b/2),e=d.r*d.i;return{r:d.r*d.r-d.i*d.i,i:e+e}}if(0==b%3){d=n(a,b/3);e=d.r*d.r;var c=d.i*
d.i;return{r:d.r*(e-3*c),i:d.i*(3*e-c)}}if(0==b%5){d=n(a,b/5);var f=d.r*d.r;e=d.i*d.i;c=f*e;c+=c;f*=f;e*=e;return{r:d.r*(f+5*(e-c)),i:d.i*(e+5*(f-c))}}return u(a,n(a,b-1))}function I(a,b){if(b==Math.floor(b)){if(0<b&&64>=b)return n(a,b);if(0>b&&-64<=b){var d=n(a,-b),e=r(d);return{r:d.r/e,i:-d.i/e}}if(0==b)return{r:1,i:0}}d=Math.atan2(a.i,a.r)*b;e=Math.pow(Math.sqrt(r(a)),b);return{r:e*Math.cos(d),i:e*Math.sin(d)}}function J(a,b){if(0==b.i)var d=I(a,b.r);else 0==a.i?(d=Math.log(a.r),d=D({r:b.r*d,i:b.i*
d})):(d={r:Math.log(Math.sqrt(r(a))),i:Math.atan2(a.i,a.r)},d=D(u(d,b)));return d}function K(a){for(var b=a.text,d=[],e=0;e<b.length;){for(var c=!1,f=b.length;f>e;--f){var g=b.substring(e,f);if(v.hasOwnProperty(g)){d.push({spaced:0==e&&a.spaced,text:g});e=f;c=!0;break}}if(!c){d.push({spaced:0==e&&a.spaced,text:b.substring(e)});break}}return d}function L(a){for(var b=/(\s*)(?:((?:\d+(?:\.\d*)?|\.\d+)(?:[eE][+-]?\d+)?|\*\*|[-+()^|,*\/!]|[a-zA-Z_]+'?)|(\S.*))/g,d=[],e;null!==(e=b.exec(a));){if(e[3])return null;
e[2]&&(e={spaced:e[1]&&0<e[1].length,text:e[2]},/^\w/.exec(e.text)?d.push.apply(d,K(e)):d.push(e))}return d}function y(a,b){for(var d=null,e=null;;){a:{var c=a;for(var k=b,g=null,h=-1,l=null;;){var m=z(c,0<=h,k);if(null===m){c=c.j==h?g:null;break a}g=null===g?m:f(l,[g,m]);if(c.j<c.tok.length)if(h=c.tok[c.j],"*"==h.text||"/"==h.text){l="*"==h.text?"mult":"div";c.j+=1;h=-1;continue}else if(!k||"|"!=h.text){l="mult";h=c.j;continue}break}c=g}if(null===c)return null;d=null===d?c:f(e,[d,c]);if(a.j<a.tok.length&&
(e=a.tok[a.j],"+"==e.text||"-"==e.text)){e="+"==e.text?"add":"sub";a.j+=1;continue}break}return d}function z(a,b,d){if(a.j<a.tok.length){var e=a.tok[a.j];if(!b&&"-"==e.text)return a.j+=1,a=z(a,d),null===a?null:f("neg",[a])}a:{b=null;for(e=-1;;){b:{var c=a;var k=d;var g=M(c);if(null===g)g=null;else for(var h=!0;h;){h=!1;if(c.j<c.tok.length&&"*"==c.tok[c.j].text){var l=!0;if(c.j+1>=c.tok.length)l=!1;else{var m=c.tok[c.j+1];if(")"==m.text||"*"==m.text||"/"==m.text||"+"==m.text||"-"==m.text||"^"==m.text||
k&&"|"==m.text)l=!1}l||(c.j+=1,g=f("conj",[g]),h=!0)}c.j<c.tok.length&&"!"==c.tok[c.j].text&&(c.j+=1,g=f("factorial",[g]),h=!0)}if(null===g)c=null;else{if(c.j<c.tok.length&&(h=c.tok[c.j],"^"==h.text||"**"==h.text)){c.j+=1;c=z(c,k);c=null===c?null:f("pow",[g,c]);break b}c=g}}if(null===c){a=a.j==e?b:null;break a}b=null===b?c:f("mult",[b,c]);if(a.j<a.tok.length&&(e=a.tok[a.j],/^[\w\d\.]/.exec(e.text)&&!e.spaced)){e=a.j;continue}break}a=b}return a}function M(a){if(a.j>=a.tok.length)return null;var b=
a.tok[a.j];if(/^\d|\./.exec(b.text))return a.j+=1,A(parseFloat(b.text));if(/^\w/.exec(b.text)){a.j+=1;if(a.j<a.tok.length&&"("==a.tok[a.j].text&&B.hasOwnProperty(b.text)){var d=B[b.text];var e=[];a.j+=1;if(0==d){if(a.j>=a.tok.length||")"!=a.tok[a.j].text)return null;a.j+=1}for(;0<d;){var c=y(a,!1);if(null==c)return null;e.push(c);--d;if(a.j>=a.tok.length||a.tok[a.j].text!=(d?",":")"))if(E.hasOwnProperty(b.text)&&a.j<a.tok.length&&")"==a.tok[a.j].text){for(;1<d;)e.push(A(0)),--d;e.push({expr:"n",vars:{n:"n"},
val:null});--d}else return null;a.j+=1}if(E.hasOwnProperty(b.text)){a={};p(a,e[0].vars);d="function(z,n)";delete a.n;"iter"==b.text&&(d="function(z,zp,n)",delete a["z'"]);d=["z",d+"{return "+e[0].expr+";}"];for(c=1;c<e.length;++c)p(a,e[c].vars),d.push(e[c].expr);return{expr:b.text+"("+d.join(",")+")",vars:a,val:null}}b=b.text;F.hasOwnProperty(b)&&(b=F[b]);return f(b,e)}if(w.hasOwnProperty(b.text))return a={},a[b.text]=w[b.text],{expr:w[b.text],vars:a,val:null};if(C.hasOwnProperty(b.text))return b=
C[b.text],{expr:"{r:"+b.r+",i:"+b.i+"}",vars:{},val:b}}if("("==b.text||"|"==b.text){a.j+=1;e=y(a,"|"==b.text);if(a.j>=a.tok.length||a.tok[a.j].text!=("|"==b.text?"|":")"))return null;a.j+=1;return"|"==b.text?f("modulus",[e]):e}return null}function A(a){return{expr:"{r:"+a+",i:0}",vars:{},val:{r:a,i:0}}}function f(a,b){for(var d={},e=[],c=[],l=0,g=eval(a),h=0;h<b.length;++h)p(d,b[h].vars),e.push(b[h].expr),c.push(b[h].val),null!==b[h].val&&++l;if(0==N(d)&&l==b.length&&0<b.length)return c=g.apply(null,
c),{expr:"{r:"+c.r+",i:"+c.i+"}",vars:d,val:c};if((g===u||g===x)&&k(1,c[1]))return b[0];if(g===u&&null!==c[0]&&0==c[0].i)return k(1,c[0])?b[1]:{expr:"scale("+c[0].r+","+e[1]+")",vars:d,val:null};if(g===x&&null!==c[1]&&0==c[1].i&&0!=c[1].r)return k(1,c[1])?b[1]:{expr:"scale("+1/c[1].r+","+e[0]+")",vars:d,val:null};if(g===x&&null!==c[0]&&0==c[0].i)return e=f("recip",[b[1]]),k(1,c[0])?e:{expr:"scale("+c[0].r+","+e.expr+")",vars:d,val:null};if(g===J){if(k(-1,c[1]))return f("recip",[b[0]]);if(k(0,c[1]))return A(1);
if(k(.5,c[1]))return f("sqrt",[b[0]]);if(k(1,c[1]))return b[0];if(k(2,c[1]))return f("square",[b[0]]);if(k(3,c[1]))return f("cube",[b[0]]);if(k(4,c[1]))return f("square",[f("square",[b[0]])]);if(k(5,c[1]))return f("p5",[b[0]]);if(k(6,c[1]))return f("square",[f("cube",[b[0]])]);if(k(Math.E,c[0]))return f("exp",[b[1]])}return{expr:a+"("+e.join(",")+")",vars:d,val:null}}function k(a,b){return null!==b&&0==b.i&&b.r==a}function N(a){var b=0,d;for(d in a)a.hasOwnProperty(d)&&++b;return b}function p(a,b){for(key in b)b.hasOwnProperty(key)&&
(a[key]=b[key])}var C={i:{r:0,i:1},pi:{r:Math.PI,i:0},e:{r:Math.E,i:0}},w={m:"m",n:"n",t:"t",r:"r",s:"s",u:"u",z:"z","z'":"zp"},B={random:0,re:1,im:1,modulus:1,arg:1,recip:1,neg:1,conj:1,disk:1,floor:1,ceil:1,square:1,cube:1,sqrt:1,exp:1,log:1,sin:1,cos:1,tan:1,cot:1,sec:1,csc:1,sinh:1,cosh:1,tanh:1,coth:1,sech:1,csch:1,asin:1,acos:1,atan:1,arcsin:1,arccos:1,arctan:1,arccot:1,arcsec:1,arccsc:1,arcsinh:1,arccosh:1,arctanh:1,arccoth:1,arcsech:1,arccsch:1,gamma:1,pow:2,binomial:2,sn:2,cn:2,dn:2,sum:2,
multIter:2,iter:3},F={asin:"arcsin",acos:"arccos",atan:"arctan"},l=[{name:"t",defn:"{r:par,i:0}",caption:function(a){return"t = "+a.toFixed(3)}},{name:"u",defn:"{r:Math.cos(Math.PI*2*par),i:Math.sin(Math.PI*2*par)}",caption:function(a){var b=Math.sin(2*Math.PI*a)+3E-16;return"u = "+(Math.cos(2*Math.PI*a)+3E-16).toFixed(2)+(0<=b?" + ":" - ")+Math.abs(b).toFixed(2)+"i"}},{name:"n",defn:"{r:Math.floor(par*par*59 + 1.5),i:0}",caption:function(a){return"n = "+Math.floor(a*a*59+1.5)}},{name:"s",defn:"{r:Math.sin(Math.PI*2*par),i:0}",
caption:function(a){return"s = "+(Math.sin(2*Math.PI*a)+3E-16).toFixed(3)}},{name:"r",defn:"{r:0.5-Math.cos(Math.PI*2*par)/2,i:0}",caption:function(a){return"r = "+(.5-Math.cos(2*Math.PI*a)/2+3E-16).toFixed(3)}}],E={iter:1,sum:1,multIter:1},v={},q=[];return function(){p(v,C);p(v,w);p(v,B);H();var a={tok:L(G),j:0};if(null===a.tok)return null;var b=y(a,!1);if(null===b||a.j<a.tok.length)return null;a=[];if(b.vars.hasOwnProperty("z'"))return null;var d="(function(z,par){";b.vars.hasOwnProperty("m")&&
(defns+="var m = expi(z); ");for(var e=0;e<l.length;++e)b.vars.hasOwnProperty(l[e].name)&&(l[e].defn&&(d+="var "+l[e].name+"="+l[e].defn+";"),a.push({name:l[e].name,caption:l[e].caption}));d+="return "+b.expr+";})";return{fn:eval(d),fntext:d,parameters:a}}()};
